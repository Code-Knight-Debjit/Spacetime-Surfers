<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Weather Prediction Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            min-height: 100vh;
            padding: 20px;
        }
        .day-theme {
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 50%, #FFA500 100%); /* Example color for daytime */
            /* color: black; */
        }

        .evening-theme {
            background: linear-gradient(to bottom, #FF8C42 0%, #FF6B9D 50%, #4A4A8C 100%); /* Example color for evening */
            /* color: white; */
        }

        .night-theme {
            background: linear-gradient(to bottom, #7171a7 0%, #1A1A3E 100%); /* Example color for nighttime */
            /* color: lightgray; */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .input-group select,
        .input-group input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group select:focus,
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .result-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            color: #667eea;
            font-weight: bold;
        }

        .chart-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .probability-section {
            margin-top: 30px;
        }

        .probability-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .probability-bar {
            background: rgba(255,255,255,0.3);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 1s ease-out;
        }

        .download-section {
            margin-top: 30px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 12px;
            text-align: center;
        }

        .download-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .info-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå§Ô∏è NASA Weather Prediction Dashboard</h1>
            <p>Advanced ML-powered weather forecasting using NASA POWER data</p>
        </div>

        <div class="dashboard">
            <div class="input-section">
                <div class="input-group">
                    <label for="citySelect">Select City <span class="info-badge">Trained Cities</span></label>
                    <select id="citySelect">
                        <option value="">-- Select a city --</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="dateInput">Select Date</label>
                    <input type="date" id="dateInput">
                </div>

                <div class="input-group" style="display: flex; align-items: flex-end;">
                    <button class="btn" onclick="predictWeather()">üîÆ Predict Weather</button>
                </div>
            </div>

            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px; color: #667eea; font-weight: 600;">Analyzing data...</p>
            </div>

            <div class="error" id="errorMsg"></div>

            <div class="results-section" id="resultsSection">
                <h2 style="margin-bottom: 20px; color: #333;">üìä Prediction Results</h2>
                
                <div id="cityInfo" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                </div>

                <div class="results-grid" id="resultsGrid">
                </div>

                <div class="probability-section" id="probabilitySection">
                    <h3 style="margin-bottom: 15px; color: #333;">üéØ Threshold Probabilities</h3>
                    <div id="probabilityCards"></div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 15px; color: #333;">üìà Historical Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="download-section">
                    <h3 style="margin-bottom: 10px; color: #333;">üíæ Download Results</h3>
                    <p style="color: #666; margin-bottom: 15px;">Export your prediction data for further analysis</p>
                    <div class="download-btns">
                        <button class="btn btn-secondary" onclick="downloadData('json')">üìÑ Download JSON</button>
                        <button class="btn btn-secondary" onclick="downloadData('csv')">üìä Download CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPrediction = null;
        let comparisonChart = null;

        // Safely get a human-readable long name for a parameter
        function safeLongName(data, param) {
            try {
                const ln = data && data.metadata && data.metadata.longnames && data.metadata.longnames[param];
                if (typeof ln === 'string') {
                    return ln.split(' at ')[0];
                }
            } catch (e) {
                // ignore and fallthrough to default
            }
            return param; // fallback to the parameter code if no long name available
        }

        // Load available cities on page load
        window.onload = function() {
            loadCities();
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dateInput').valueAsDate = tomorrow;
        };

        async function loadCities() {
            try {
                const response = await fetch('/api/cities');
                const data = await response.json();
                
                const select = document.getElementById('citySelect');
                data.cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
            } catch (error) {
                showError('Failed to load cities. Please ensure models are trained.');
            }
        }

        async function predictWeather() {
            const city = document.getElementById('citySelect').value;
            const dateInput = document.getElementById('dateInput').value;

            if (!city) {
                showError('Please select a city');
                return;
            }

            if (!dateInput) {
                showError('Please select a date');
                return;
            }

            // Convert date to YYYYMMDD format
            const date = new Date(dateInput);
            const dateStr = date.getFullYear() + 
                          String(date.getMonth() + 1).padStart(2, '0') + 
                          String(date.getDate()).padStart(2, '0');

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ city, date: dateStr })
                });

                if (!response.ok) {
                    throw new Error('Prediction failed');
                }

                const data = await response.json();
                currentPrediction = data;
                displayResults(data);
            } catch (error) {
                showError('Prediction failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayResults(data) {
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';

            // Display city info
            const cityInfo = document.getElementById('cityInfo');
            cityInfo.innerHTML = `
                <strong>üìç Location:</strong> ${data.city} | 
                <strong>üåê Coordinates:</strong> ${data.coordinates.lat}¬∞N, ${data.coordinates.lon}¬∞E | 
                <strong>üìÖ Date:</strong> ${formatDate(data.date)}
            `;

            // Display predictions
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            const parameterOrder = ['T2M', 'RH2M', 'WS2M', 'PRECTOTCORR'];
            const icons = {
                'T2M': 'üå°Ô∏è',
                'RH2M': 'üíß',
                'WS2M': 'üí®',
                'PRECTOTCORR': 'üåßÔ∏è'
            };

            parameterOrder.forEach(param => {
                if (data.predictions[param] !== undefined) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    
                    const stats = data.statistics[param];
                    
                    card.innerHTML = `
                        <h3>${icons[param]} ${safeLongName(data, param)}</h3>
                        <div class="metric">
                            <span class="metric-label">Predicted Value:</span>
                            <span class="metric-value">${data.predictions[param]} ${data.metadata.units[param]}</span>
                        </div>
                        ${stats ? `
                        <div class="metric">
                            <span class="metric-label">Historical Mean:</span>
                            <span class="metric-value">${stats.mean} ${data.metadata.units[param]}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Historical Range:</span>
                            <span class="metric-value">${stats.min} - ${stats.max} ${data.metadata.units[param]}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Std Deviation:</span>
                            <span class="metric-value">¬±${stats.std} ${data.metadata.units[param]}</span>
                        </div>
                        ` : ''}
                    `;
                    
                    resultsGrid.appendChild(card);
                }
            });

            // Display probabilities
            displayProbabilities(data.probabilities);

            // Create comparison chart
            createComparisonChart(data);
        }

        function displayProbabilities(probabilities) {
            const container = document.getElementById('probabilityCards');
            container.innerHTML = '';

            if (probabilities.T2M) {
                const tempCard = document.createElement('div');
                tempCard.className = 'probability-card';
                tempCard.innerHTML = '<h4 style="margin-bottom: 10px;">üå°Ô∏è Temperature Thresholds</h4>';
                
                Object.entries(probabilities.T2M).forEach(([key, value]) => {
                    const threshold = key.replace('above_', '').replace('C', '');
                    tempCard.innerHTML += `
                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Above ${threshold}¬∞C</span>
                                <span style="font-weight: bold;">${value}%</span>
                            </div>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${value}%">
                                    ${value}%
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.appendChild(tempCard);
            }

            if (probabilities.PRECTOTCORR) {
                const precipCard = document.createElement('div');
                precipCard.className = 'probability-card';
                precipCard.innerHTML = '<h4 style="margin-bottom: 10px;">üåßÔ∏è Precipitation Thresholds</h4>';
                
                Object.entries(probabilities.PRECTOTCORR).forEach(([key, value]) => {
                    const threshold = key.replace('above_', '').replace('mm', '');
                    precipCard.innerHTML += `
                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Above ${threshold} mm/day</span>
                                <span style="font-weight: bold;">${value}%</span>
                            </div>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${value}%">
                                    ${value}%
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.appendChild(precipCard);
            }
        }

        function createComparisonChart(data) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }

            const parameters = Object.keys(data.predictions);
            const predictedValues = parameters.map(p => data.predictions[p]);
            const meanValues = parameters.map(p => data.statistics[p]?.mean || 0);
            const labels = parameters.map(p => safeLongName(data, p));

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Predicted Value',
                            data: predictedValues,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Historical Mean',
                            data: meanValues,
                            backgroundColor: 'rgba(252, 182, 159, 0.8)',
                            borderColor: 'rgba(252, 182, 159, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Predicted vs Historical Mean Values',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value (mixed units)'
                            }
                        }
                    }
                }
            });
        }

        async function downloadData(format) {
            if (!currentPrediction) {
                showError('No prediction data to download');
                return;
            }

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city: currentPrediction.city,
                        date: currentPrediction.date,
                        format: format
                    })
                });

                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `weather_prediction_${currentPrediction.city}_${currentPrediction.date}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                showError('Download failed: ' + error.message);
            }
        }

        function formatDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function showLoading(show) {
            document.querySelector('.loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        function setTimeBasedTheme() {
            const now = new Date();
            const hour = now.getHours(); // Get the current hour (0-23) 
            const body = document.body;

        // Remove any existing theme classes
            body.classList.remove('day-theme', 'evening-theme', 'night-theme');

            if (hour >= 6 && hour < 18) { // 6 AM to 5:59 PM (day)
                body.classList.add('day-theme');
            } else if (hour >= 18 && hour < 22) { // 6 PM to 9:59 PM (evening)
                body.classList.add('evening-theme');
            } else { // 10 PM to 5:59 AM (night)
                body.classList.add('night-theme');
            }
        }

        // Call the function when the page loads
        setTimeBasedTheme();

        // Optionally, update the theme periodically (e.g., every minute)
        // setInterval(setTimeBasedTheme, 60 * 1000);
    </script>
</body>
</html>